# ============================================================================
# Azure Pipeline for TaskMaster.Contracts
# ============================================================================
# Shared contracts library for TaskMaster microservices
# Builds, tests, and publishes NuGet package to Azure Artifacts
# ============================================================================

trigger:
  branches:
    include:
      - main
  tags:
    include:
      - 'v*'
  paths:
    exclude:
      - '**/*.md'
      - 'docs/**'

pr:
  branches:
    include:
      - main
  paths:
    exclude:
      - '**/*.md'
      - 'docs/**'

pool:
  vmImage: 'ubuntu-latest'

variables:
  # Link to Variable Group with AZURE_ARTIFACTS_PAT
  - group: NuGet-Publishing
  
  # Pipeline Variables
  - name: buildConfiguration
    value: 'Release'
  - name: feedName
    value: 'tm-packages'
  - name: feedUrl
    value: 'https://pkgs.dev.azure.com/jasonberkes/TaskMaster/_packaging/tm-packages/nuget/v3/index.json'

stages:
  # ============================================================================
  # Stage 1: Build and Test
  # ============================================================================
  - stage: Build
    displayName: 'Build & Test'
    jobs:
      - job: BuildTest
        displayName: 'Build, Test, Pack'
        steps:
          - checkout: self
            fetchTags: true
            fetchDepth: 0

          # Setup .NET 10
          - task: UseDotNet@2
            displayName: 'Setup .NET 10'
            inputs:
              packageType: 'sdk'
              version: '10.0.x'
              includePreviewVersions: true

          # Cache NuGet packages
          - task: Cache@2
            displayName: 'Cache NuGet packages'
            continueOnError: true
            inputs:
              key: 'nuget | "$(Agent.OS)" | **/*.csproj'
              restoreKeys: |
                nuget | "$(Agent.OS)"
              path: '$(HOME)/.nuget/packages'

          # Restore
          - task: DotNetCoreCLI@2
            displayName: 'Restore'
            inputs:
              command: 'restore'
              projects: '**/*.csproj'

          # Build
          - task: DotNetCoreCLI@2
            displayName: 'Build'
            inputs:
              command: 'build'
              projects: '**/*.csproj'
              arguments: '--configuration $(buildConfiguration) --no-restore'

          # Determine Version
          - bash: |
              if [[ "$(Build.SourceBranch)" == refs/tags/v* ]]; then
                VERSION="${BUILD_SOURCEBRANCHNAME#v}"
              elif [[ "$(Build.SourceBranch)" == "refs/heads/main" ]]; then
                BASE_VERSION=$(grep -oPm1 "(?<=<Version>)[^<]+" src/TaskMaster.Contracts/TaskMaster.Contracts.csproj || echo "1.0.0")
                VERSION="${BASE_VERSION}"
              else
                BASE_VERSION=$(grep -oPm1 "(?<=<Version>)[^<]+" src/TaskMaster.Contracts/TaskMaster.Contracts.csproj || echo "1.0.0")
                VERSION="${BASE_VERSION}-beta.$(Build.BuildId)"
              fi
              echo "##vso[task.setvariable variable=packageVersion;isOutput=true]$VERSION"
              echo "Package version: $VERSION"
            displayName: 'Determine Version'
            name: versionOutput

          # Pack
          - task: DotNetCoreCLI@2
            displayName: 'Pack NuGet'
            inputs:
              command: 'pack'
              packagesToPack: 'src/TaskMaster.Contracts/TaskMaster.Contracts.csproj'
              configuration: '$(buildConfiguration)'
              nobuild: true
              versioningScheme: 'byEnvVar'
              versionEnvVar: 'VERSIONOUTPUT_PACKAGEVERSION'
              outputDir: '$(Build.ArtifactStagingDirectory)/packages'

          # Publish Artifact
          - task: PublishBuildArtifacts@1
            displayName: 'Publish NuGet Artifact'
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)/packages'
              ArtifactName: 'nuget-package'
              publishLocation: 'Container'

  # ============================================================================
  # Stage 2: Publish to Azure Artifacts
  # ============================================================================
  - stage: Publish
    displayName: 'Publish NuGet'
    dependsOn: Build
    condition: and(succeeded(), or(eq(variables['Build.SourceBranch'], 'refs/heads/main'), startsWith(variables['Build.SourceBranch'], 'refs/tags/v')))
    jobs:
      - job: PublishNuGet
        displayName: 'Publish to Azure Artifacts'
        steps:
          # Download artifact
          - task: DownloadBuildArtifacts@1
            displayName: 'Download NuGet Package'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'nuget-package'
              downloadPath: '$(System.ArtifactsDirectory)'

          # Push to Azure Artifacts
          - task: NuGetCommand@2
            displayName: 'Push to Azure Artifacts'
            inputs:
              command: 'push'
              packagesToPush: '$(System.ArtifactsDirectory)/nuget-package/*.nupkg'
              nuGetFeedType: 'internal'
              publishVstsFeed: 'TaskMaster/tm-packages'
              allowPackageConflicts: true
